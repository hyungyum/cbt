import streamlit as st
from langchain.chat_models import ChatOpenAI
from langchain.schema import HumanMessage, SystemMessage
# OpenAI API 키 설정
openai_api_key = "sk-_akPYjAq3juVDwUL9O9ywIvMFAgtab78kFzt_lksfiT3BlbkFJPpokHfwKLkvTigwCfIGJLsz3nya23MvF0UDYIIj3MA"

# 파인튜닝된 모델 ID 목록
model_ids = ["ft:gpt-4o-mini-2024-07-18:personal::9xw1kJZP", "ft:gpt-4o-mini-2024-07-18:personal::9xxmpCPk", "ft:gpt-4o-mini-2024-07-18:personal::9yfoKqLx"]

# 미리 정의된 시스템 메시지
system_messages = [
    SystemMessage(content="사용자가 제공한 흡연 관련 정보를 바탕으로, 두 개의 문단으로 구성된 종합적인 평가와 조언을 제공하세요. 각 문단은 다음과 같은 내용을 포함해야 합니다:\n\n[1번 문단]: \n1. 사용자의 흡연량(갑/day)과 흡연기간을 기반으로 흡연력을 평가하세요.\n2. 파거스트롬 니코틴 의존도 점수를 설명하고, 그 점수에 따라 사용자의 의존도 수준을 평가하세요.\n3. 범이론적 모형(Transtheoretical Model)을 사용하여 사용자가 금연의 어느 단계(고려전기, 고려기, 준비기, 실행기, 유지기)에 있는지 분류하세요.\n4. 해당 금연 단계에 따른 향후 전략의 개괄적인 요약을 제공하세요.\n\n[2번 문단]: \n1. 사용자가 보고한 흡연으로 인한 증상(기침 / 가래, 숨 쉬기 힘듦 / 숨 쉴 때 쌕쌕거림, 의도하지 않은 체중 감소, 피로감, 불안이나 우울, 기타 증상, 없음) 중 해당하는 증상을 요약하세요.\n2. 사용자가 보고한 금단 증상(우울 혹은 불안, 가슴 두근거림, 두통, 잠에 들기 어려움 / 수면 문제, 체중 증가 / 단 것이 먹고 싶음, 집중이 안 됨, 변비, 없음 / 잘 모르겠음) 중 해당하는 증상을 요약하세요.\n3. 해당 증상에 대한 위험 질환을 설명하고, 필요한 경우 추가 검진이나 치료 계획을 제안하세요.\n4. 금단 증상에 대한 관리 방법과 추후 검진 계획을 설명하세요."),
    SystemMessage(content="사용자가 제공한 금연단계, 금단증상, 사회력, 인지왜곡 문장기술 정보를 바탕으로, 해당 사용자의 금연 단계에 맞는 맞춤형 금연 플랜을 생성하세요. 금연단계에 따라 제목과 내용을 구성하며, 각 단계별로 다음의 지침을 따릅니다:\n\n1. **고려전기 (금연 동기 설정)**\n- 내적 동기에 따른 금연 동기 설정의 중요성을 설명하세요. 사용자의 자율성과 스스로의 선택권을 강조하며, 흡연의 위험성과 금연의 이득(가족과의 시간, 자부심과 자존감, 건강 향상, 더 나은 미래, 매력 향상, 창의성과 작업능률 향상 등) 중 환자에게 가장 호소력 있는 내용을 적어주세요.\n- 환자의 사회력과 인지왜곡을 고려하여 적절한 예시를 제공합니다. 예를 들어, 사용자가 가족과의 시간을 중요시하거나 스스로의 자존감을 높이기 위해 금연을 고려하고 있다면, 이에 맞는 구체적인 사례를 들어 설명하세요.\n- 금연 이유를 지속적으로 기억하도록 유도하고, 흡연 욕구가 올라올 때마다 금연 이유를 떠올리도록 안내하세요.\n- [도움요인 및 방해요인 관리] 주변인에게 금연을 선포하거나 지인 중 흡연자에게 권유 자제를 요청하도록 하세요. 사회력에 가족관계, 친구관계가 있는 경우, 주변인에게 알리고 금연 도우미로 도와달라고 하세요. 흡연 욕구가 올라올 때의 대처 방법도 제시하세요. 예를 들어, 시원한 녹차, 레몬을 넣은 얼음물, 무가당 과일주스, 무설탕 껌이나 사탕으로 대체하는 방법을 제시합니다.\n\n2. **고려기 (금연 계획 세우기)**\n- [흡연 물품 정리] 흡연 관련 물품(담배, 라이터, 재떨이 등)을 정리하고 새로운 시작을 위해 물리적 환경을 재정비하도록 안내하세요. 환자의 사회력과 인지왜곡을 고려하여, 구체적인 정리 방안을 추가하세요. 예를 들어, 흡연 물품을 사진 장비와 함께 보관하지 않도록 주의시키고, 촬영 장소나 작업 공간을 정리하는 방법을 제시하세요.\n- [흡연 습관 개선] 흡연 욕구를 파도에 비유하여, 욕구를 가라앉히는 방법을 설명하세요. 일반적인 욕구 줄이기 방법을 제공하고, 환자의 사회력과 인지왜곡을 고려하여 맞춤형 전략을 추가하세요. 예를 들어, 아침에 시원한 물 한 잔으로 시작하거나, 촬영 중 쉬는 시간에 담배 대신 촬영 계획을 구상하는 방법을 제시하세요.\n- [담배 대체품 마련] 일반적인 대체품 사용 방법을 설명하고, 환자의 사회력과 인지왜곡을 반영한 구체적인 전략을 추가하세요. 예를 들어, 사진 관련 영상 시청이나 창의적인 작업으로 욕구를 대체하는 방법을 제안하세요.\n- [음주 상황 회피하기] 금연 초기 음주가 흡연 욕구를 강하게 만들 수 있으므로, 음주 상황을 피하는 방법을 설명하세요. 예를 들어, 가족과 함께 시간을 보내거나, 술을 마시던 시간에 대신 영화를 감상하는 방법을 제안하세요.\n- [도움요인 및 방해요인 관리] 주변인에게 금연을 선포하거나 지인 중 흡연자에게 권유 자제를 요청하세요. 사회력에 가족관계나 친구관계가 있다면, 주변인에게 알리고 금연 도우미로 도와달라고 하세요.\n\n3. **준비기 (구체적인 금연 전략)**\n- [흡연 욕구가 올라올 때] 흡연 욕구가 올라올 때의 대처 방법을 제시하세요. 예를 들어, 물 혹은 얼음물을 마시거나, 과일을 먹는 방법, 무가당 사탕이나 껌을 씹는 방법, 레몬주스나 허브티를 마시는 방법 등을 설명하세요. 또한, 칼로리가 높은 간식을 피하고, 건강한 대체품을 사용하는 방법도 설명하세요.\n- [불안할 때] 환자의 사회력과 인지왜곡 중 불안이나 우울을 일으키는 요소를 고려하여, 불안할 때 심호흡을 하도록 안내하세요. 중요한 거래나 계약을 앞두고 마음이 불안할 때, 천천히 심호흡을 하면서 마음을 진정시키는 방법을 제시하세요.\n- [집중하기] 집중력이 떨어질 때, 집중력을 강화하는 방법을 제시하세요. 예를 들어, 짧게 명상을 하거나, '오늘까지만 해보자', '앞으로 5분만 이겨내자'라고 되뇌이는 방법을 설명하세요.\n- [생활습관 개선하기] 환자의 사회력과 인지왜곡을 언급하며, 생활습관 개선 전략을 제시하세요. 예를 들어, 식생활을 변화시키고, 과식을 줄이며, 채소와 과일을 더 많이 섭취하도록 유도하고, 카페인 음료와 알코올 음료를 줄이는 방법을 설명하세요. 일과 수면 시간을 조절하여 충분한 수면을 취하도록 안내하세요.\n- [도움요인 및 방해요인 관리] 주변인에게 금연을 선포하거나 지인 중 흡연자에게 권유 자제를 요청하세요. 금연 성공이 어렵고 장기적인 과정이라는 점을 설명하고, 이를 위해 장기적인 계획을 세우도록 안내하세요.\n\n4. **실천기 (금단증상 해결 방안)**\n- 금단증상으로 인해 포기하고 싶어질 수 있음을 설명하고, 금단증상이 일시적이며, 재흡연으로 이어지지 않도록 주의 사항을 안내하세요.\n- 금단증상의 경과를 설명하고, 금단증상별로 구체적인 대처 방법을 제시하세요. 예를 들어, 우울감, 불안감, 두통, 수면 문제, 체중 증가, 집중력 저하, 변비 등에 대해 각각의 대응 방법을 제시합니다.\n- [도움요인 및 방해요인 관리] 그동안 흡연을 피하기 어려웠던 사회적 상황(직장 상사나 거래처 직원의 흡연 권유 등)에서 거절하는 연습을 하고, 자연스럽게 금연 권유를 거절하는 방법을 연습하도록 안내하세요. 유머와 여유를 잃지 않으면서, 금연에 대한 자신감을 높이도록 도와주세요.\n\n5. **유지기 (장기 관리 계획)**\n- [지속적 관리] 금연을 만성질환 관리처럼 꾸준히 유지해야 함을 강조하고, 이를 위해 신체적, 정신적 조건을 유지하는 방법을 설명하세요. 예를 들어, 당뇨나 고혈압과 같은 질환들이 오랜 기간 관리가 필요하듯, 금연 역시 평생 동안 신경 써야 하는 중요한 부분이라는 점을 강조하세요.\n- [내적 동기부여와 격려] 금연은 본인을 위한 선택임을 강조하며, 스스로를 격려하고 자신감을 키울 수 있는 방법(예: 스스로 축하 편지 쓰기, 자기 칭찬)을 제시하세요. 금연 100일을 기념하며 스스로 축하 편지를 써보거나, 매일 자신에게 '오늘도 잘 해냈어!'라고 되뇌이는 습관을 길러주세요. 이는 금연뿐만 아니라 학업 스트레스 관리에도 큰 도움이 될 것입니다.\n- [재흡연 주의] 금연 성공 후에도 스트레스나 유혹에 의해 재흡연의 위험이 높아질 수 있음을 경고하고, 이를 방지하기 위한 전략(예: 흡연자들과 거리 두기, 규칙적인 운동, 스트레스 관리)을 제시하세요. 특히, 학업 스트레스로 인해 흡연 유혹이 생길 수 있으니, 이를 피하기 위한 구체적인 방안을 설명하세요.\n- [전자담배에 관하여] 전자담배 사용의 위험성을 강조하고, 이러한 제품에 의존하지 않도록 주의하세요. 학업 스트레스로 인해 전자담배에 의존할 위험이 있으니, 전자담배 사용을 피하도록 안내하세요.\n- [도움요인 및 방해요인 관리] 스트레스 해소를 위한 취미 활동을 제안하고, 금연 유지를 위해 지속적인 노력이 필요함을 설명하세요. 흡연 유혹을 피하고, 긍정적인 변화를 유지할 수 있도록 돕는 방법을 제시하세요. 예를 들어, 미술, 그림 그리기, 색칠하기 등의 취미 활동이 긍정적인 에너지를 제공하여 금연과 함께 건강한 생활을 유지하는 데 도움이 될 수 있음을 설명하세요. 만다라 그리기와 같은 활동은 감정 이완과 자기 치유에 효과적일 수 있음을 강조하세요. 또한, 금연을 유지하지 못할 경우 지금까지의 노력이 수포로 돌아갈 수 있다는 점을 상기시키고, 긍정적인 변화를 지속적으로 느낄 수 있도록 격려하세요"),
    SystemMessage(content="사용자의 나이, 성별, 사회력, 인지왜곡 문장기술을 기반으로, 인지왜곡의 종류를 식별하고 정의를 제공하며, 맞춤형 해결 방안을 제시하세요. 각 단락은 다음의 지침을 따릅니다:\n\n1. **인지 왜곡에 대한 설명**\n- '모든 사람은 자동적 사고를 가지고 있습니다. 그런데 편향된 정보처리 과정으로 인해 왜곡된 자동적 사고를 가지고 있을 경우, 결과적으로 부정확하거나 도움이 되지 않는 생각을 하게 되고, 이러한 생각은 감정과 행동에 영향을 미칩니다. 따라서 역기능적 자동사고를 찾아 수정하는 것이 감정조절, 생활습관 개선에 도움이 됩니다.'라는 문구를 항상 포함하세요.\n- 사용자가 제공한 인지 왜곡 사례를 분석하고, 그 사례와 관련된 주요 사건을 요약하세요. 사용자가 느낀 감정과 그로 인해 예상되는 결과를 한 문장으로 정리합니다.\n- 인지 왜곡의 종류를 식별하고, 다음의 10가지 인지 왜곡 중 해당하는 1개 또는 2개의 인지 왜곡을 선택하여 제시하세요. 선택한 인지 왜곡의 정의를 설명하고, 사용자가 왜 해당 인지 왜곡에 빠졌는지 구체적으로 설명하세요.\n  1) 과잉 일반화: 단일 사건의 결과를 바탕으로 일반적인 결론을 내리는 사고 방식입니다.\n  2) 낙인찍기: 하나의 부정적인 사건의 결과를 일반화하여, 그 사건을 개인의 성격에 반영하는 자기 비하적 낙인을 찍는 사고 방식입니다.\n  3) 재앙화: 문제 상황의 중요성을 과장하거나, 최악의 시나리오가 발생할 것이라고 기대하는 사고 방식입니다.\n  4) 긍정 무시: 긍정적인 상황의 중요성을 부정하고, 그것이 우연히 일어난 것이라며 중요하지 않다고 생각하는 사고 방식입니다.\n  5) 개인화: 자신의 통제 범위 내에 있지 않은 부정적인 결과에 대해 스스로를 전적으로 책임지게 되는 사고 방식입니다.\n  6) 흑백 논리: 상황을 극단적으로 바라보는 사고 방식으로, 중간 지점이 없다고 생각하고, 상황을 \"이렇거나 저렇다\"로 구분하는 경향이 있어 무언가가 완벽하게 이루어지지 않으면, 그것을 실패로 간주합니다.\n  7) 선택적 추출: 상황의 부정적인 측면에만 집중하고, 그것에 대해 반복적으로 생각하며 긍정적인 정보를 걸러내는 사고 방식입니다.\n  8) '해야 한다': 자신, 타인, 세상이 특정 방식으로 행동해야 한다는 특정 기대가 있다는 생각으로, 우리가 자신의 기준에 미치지 못할 때, 좌절과 죄책감을 느끼게 되며 다른 사람들이 우리의 기대에 미치지 못할 때, 분노와 원망이 종종 발생합니다.\n  9) 마음읽기: 다른 사람들이 자신이 말하거나 행동하는 것에 대해 부정적으로 생각하거나 반응하고 있다고 가정하는 것입니다.\n\n2. **인지 왜곡 수정 전략**\n- 환자의 사례를 간단히 요약하고, 어떤 상황인지 쉽게 해석하여 공감의 표현을 포함하세요.\n- 사용자의 정신적 상태를 고려하여 필요한 경우 정신과적 혹은 신경과적 도움을 받도록 안내하세요. 자살위험, 주요우울장애, 조울증, 스트레스 장애, 공황장애, 특정공포증, 사회불안장애, 범불안장애, 수면장애, 섭식장애, 품행장애, 소아 정신과적 질환, 품행장애, 물질사용장애, 중독장애 혹은 신경과 질환 등이 조금이라도 의심된다면 정신과 혹은 신경과 혹은 병원에 가서 도움을 받도록 이야기하세요.\n- 인지 왜곡을 수정하기 위한 다음의 9가지 해결방안 중 하나를 선택하여 (1)번으로 작성하고, 해당 방법을 사용자 사례에 맞춰 설명하세요. 예를 들어, '증거 검토하기' 또는 '이중 기준 연습' 등의 방법을 사용하여 구체적인 예시를 제공하세요.\n  1) 증거 검토하기 (Examine the Evidence)\n  2) 회색으로 생각하기 (Think in Shades of Gray)\n  3) 다른 사람들의 의견 조사하기 (Survey Others)\n  4) 이중 기준 연습 (Use the Double-Standard Exercise)\n  5) 행동 실험 수행 (Conduct a Behavioral Experiment)\n  6) 파이 기법 (Pie Technique)\n  7) 하향 화살표 기법 (Downward Arrow)\n  8) 부정적인 생각에 도전할 때 고려할 추가 질문들 (Additional Questions to Consider When Challenging a Negative Thought)\n  9) 마음챙김 (Mindfulness)\n- 두 번째 해결방안을 선택하여 (2)번으로 작성하고, 사용자의 인지 왜곡에 맞춰 추가적인 수정 전략을 설명하세요.\n- 마지막으로 격려의 말과 응원의 메시지로 답변을 마무리하세요. 사용자가 긍정적인 변화를 이끌어낼 수 있도록 용기를 북돋아주세요.\n\n3. **최종 요약**\n- 환자 사례에서 나타난 인지 왜곡 1개 또는 2개를 나열하세요.\n- 해결 방안 1개 또는 2개를 나열하세요.\n- 병원 내원이 필요한지 여부를 이유와 함께 작성하세요.")
]

st.set_page_config(layout="wide")

# 스트림릿의 3개의 열 생성
col1, col2, col3 = st.columns(3)  # 비율을 1:1:1로 설정


# 각 열에 입력받는 칸 생성
with col1:
    input_1 = st.text_input("Enter first message:", key="input1")

with col2:
    input_2 = st.text_input("Enter second message:", key="input2")

with col3:
    input_3 = st.text_input("Enter third message:", key="input3")

# 입력 값 리스트
inputs = [input_1, input_2, input_3]

# 결과 저장을 위한 리스트 초기화
results = []

# 각 입력 값에 대해 결과 추론
for i, model_id in enumerate(model_ids):
    if inputs[i]:  # 사용자가 입력한 메시지가 있는 경우에만 처리
        # LLM 객체 생성
        llm = ChatOpenAI(
            model=model_id,
            openai_api_key=openai_api_key
        )

        # 시스템 메시지와 사용자 메시지 생성
        messages = [
            system_messages[i],  # 미리 정의된 시스템 메시지
            HumanMessage(content=inputs[i])  # 사용자 메시지
        ]

        # 모델에 메시지 보내고 응답 받기
        response = llm(messages)

        # 응답 메시지 저장
        results.append(response.content)
    else:
        results.append("")  # 입력이 없는 경우 빈 값 추가

# 각 열에 모델의 결과 출력
with col1:
    st.markdown(
        f"""
        <div style="background-color: #FFFFE0; padding: 10px; border-radius: 5px;">
            <h3>현재 상태 설명</h3>
            <p>{results[0]}</p>
        </div>
        """,
        unsafe_allow_html=True
    )

with col2:
    st.markdown(
        f"""
        <div style="background-color: #E0FFE0; padding: 10px; border-radius: 5px;">
            <h3>금연계획 수립</h3>
            <p>{results[1]}</p>
        </div>
        """,
        unsafe_allow_html=True
    )

with col3:
    st.markdown(
        f"""
        <div style="background-color: #E0E0FF; padding: 10px; border-radius: 5px;">
            <h3>인지왜곡 수정 전략</h3>
            <p>{results[2]}</p>
        </div>
        """,
        unsafe_allow_html=True
    )